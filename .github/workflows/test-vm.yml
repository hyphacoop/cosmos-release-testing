name: Test VM runner
on:
  push:
jobs:
  provision-runner:
    runs-on: cosmos-runner-set
    steps:
      - name: Install required packages
        run: |
          sudo apt update
          sudo apt -y install python-is-python3 python3-distutils python3-venv python3-pip git
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Init Python venv
        run: python -m venv ~/env
      - name: Install dependencies
        run: |
          source ~/env/bin/activate
          python -m pip install --upgrade pip
          python -m pip install ansible proxmoxer requests
      - name: Provision runner VM
        env:
          PROXMOX_SECRET: ${{ secrets.PROXMOX_SECRET }}
        run: |
          source ~/env/bin/activate
          cd ansible
          ansible-playbook provision-runner.yml -e "api_password=$PROXMOX_SECRET"
  run-on-vm:
    needs: provision-runner
    runs-on: cosmos-ubuntu2404-vm-set
    steps:
      # Get system info
      - run: cat /proc/cpuinfo
