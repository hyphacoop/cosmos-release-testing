---
name: Test Joining Release Testnet
on:
  workflow_dispatch:
  schedule:
    # At 05:30 on Tuesday.
    - cron: '30 5 * * 2'
  push:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      # Get system info
      - run: ifconfig
      - run: lscpu
      - run: df -h
      - run: free -m
      - run: uname -a
      - run: lsb_release -a
      - run: echo "GitHub branch is ${{ github.ref }}"
      - run: whoami
      - run: pwd
      - name: mkdir ~/artifact
        run: mkdir ~/artifact
      - name: Update Apt
        run: |
          sudo apt update
          sudo apt dist-upgrade -y
      - name: Install required packages
        run: |
          sudo apt update
          sudo apt -y install python-is-python3 python3-distutils screen curl jq wget python3-venv python3-pip
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Init Python venv
        run: python -m venv ~/env
      - name: Install dependencies
        run: |
          source ~/env/bin/activate
          python -m pip install --upgrade pip
          python -m pip install toml-cli requests
      - name: Get current running gaiad version
        run: |
          RUNNING_VERSION=$(curl -s https://rpc.sentry-01.theta-testnet.polypore.xyz/abci_info | jq -r '.result.response.version')
          echo "Chain is running gaiad version: $RUNNING_VERSION"
          echo "RUNNING_VERSION=$RUNNING_VERSION" >> $GITHUB_ENV
      - name: Download binary from cosmos/gaia repo
        run: |
          sudo wget -nv https://github.com/cosmos/gaia/releases/download/${{ env.RUNNING_VERSION }}/gaiad-${{ env.RUNNING_VERSION }}-linux-amd64 -O /usr/local/bin/gaiad
          sudo chmod +x /usr/local/bin/gaiad
      - name: Initializing chain to sync with Release Testnet
        env:
          NODE_HOME: /home/runner/.gaia
          NODE_MONIKER: thetatestnet
          CHAIN_ID: theta-testnet-001
          CHAIN_BINARY: 'gaiad'
          GENESIS_URL: https://github.com/cosmos/testnets/raw/master/public/genesis.json.gz
          SEEDS: "639d50339d7045436c756a042906b9a69970913f@seed-01.theta-testnet.polypore.xyz:26656,3e506472683ceb7ed75c1578d092c79785c27857@seed-02.theta-testnet.polypore.xyz:26656"
          SYNC_RPC_1: https://rpc.state-sync-01.theta-testnet.polypore.xyz:443
          SYNC_RPC_2: https://rpc.state-sync-02.theta-testnet.polypore.xyz:443
          GAS_PRICES: "0.0025uatom"
        run: |
          echo "Initializing $NODE_HOME..."
          $CHAIN_BINARY config chain-id $CHAIN_ID --home $NODE_HOME
          $CHAIN_BINARY config keyring-backend test --home $NODE_HOME
          $CHAIN_BINARY config broadcast-mode block --home $NODE_HOME
          $CHAIN_BINARY init $NODE_MONIKER --chain-id $CHAIN_ID --home $NODE_HOME
          sed -i -e "/seeds =/ s^= .*^= \"$SEEDS\"^" $NODE_HOME/config/config.toml
          echo "Configuring state sync..."
          CURRENT_BLOCK=$(curl -s $SYNC_RPC_1/block | jq -r '.result.block.header.height')
          TRUST_HEIGHT=$[$CURRENT_BLOCK-1000]
          TRUST_BLOCK=$(curl -s $SYNC_RPC_1/block\?height\=$TRUST_HEIGHT)
          TRUST_HASH=$(echo $TRUST_BLOCK | jq -r '.result.block_id.hash')
          HALT_HEIGHT=$[$CURRENT_BLOCK+50]
          sed -i -e '/enable =/ s/= .*/= true/' $NODE_HOME/config/config.toml
          sed -i -e '/trust_period =/ s/= .*/= "8h0m0s"/' $NODE_HOME/config/config.toml
          sed -i -e "/trust_height =/ s/= .*/= $TRUST_HEIGHT/" $NODE_HOME/config/config.toml
          sed -i -e "/trust_hash =/ s/= .*/= \"$TRUST_HASH\"/" $NODE_HOME/config/config.toml
          sed -i -e "/rpc_servers =/ s^= .*^= \"$SYNC_RPC_1,$SYNC_RPC_2\"^" $NODE_HOME/config/config.toml
          sed -i -e "/halt-height =/ s^= .*^= \"$HALT_HEIGHT\"^" $NODE_HOME/config/app.toml
          sed -i -e "/minimum-gas-prices =/ s^= .*^= \"$GAS_PRICES\"^" $NODE_HOME/config/app.toml
          echo "Replaceing genesis..."
          wget -nv $GENESIS_URL -O genesis.json.gz
          gunzip genesis.json.gz
          mv genesis.json $NODE_HOME/config/genesis.json
          echo "halt-height set to: $HALT_HEIGHT"
          echo "HALT_HEIGHT=$HALT_HEIGHT" >> $GITHUB_ENV
          cat $NODE_HOME/config/app.toml
      - name: Start Chain
        env:
          NODE_HOME: /home/runner/.gaia
          CHAIN_BINARY: 'gaiad'
        run: $CHAIN_BINARY start --x-crisis-skip-assert-invariants --home $NODE_HOME
